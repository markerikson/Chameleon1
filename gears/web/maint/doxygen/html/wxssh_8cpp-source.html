<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Chameleon: wxssh.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>wxssh.cpp</h1><a href="wxssh_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">//</span>
00003 <span class="comment">//    Based on Derry Bryson's taTelnet, Copyright 2000</span>
00004 <span class="comment">//</span>
00006 <span class="comment"></span><span class="preprocessor">#include "<a class="code" href="wxssh_8h.html">wxssh.h</a>"</span>
00007 <span class="preprocessor">#include "../common/debug.h"</span>
00008 
00009 <span class="preprocessor">#ifdef _DEBUG</span>
00010 <span class="preprocessor"></span><span class="preprocessor">#define new DEBUG_NEW</span>
00011 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00012 <span class="preprocessor"></span>
00013 
00014 BEGIN_EVENT_TABLE(<a class="code" href="classwx_s_s_h.html">wxSSH</a>, <a class="code" href="classwx_term.html">wxTerm</a>)
00015     <a class="code" href="chameleonprocessevent_8h.html#a1">EVT_PROCESS_STDOUT</a>(wxSSH::OnPlinkOut)
00016     <a class="code" href="chameleonprocessevent_8h.html#a2">EVT_PROCESS_STDERR</a>(wxSSH::OnPlinkErr)
00017     <a class="code" href="chameleonprocessevent_8h.html#a0">EVT_PROCESS_ENDED</a>(wxSSH::OnPlinkTerm)
00018 END_EVENT_TABLE()
00019 
<a name="l00020"></a><a class="code" href="classwx_s_s_h.html#a0">00020</a> <a class="code" href="classwx_s_s_h.html#a0">wxSSH::wxSSH</a>(wxWindow* parent, wxWindowID <span class="keywordtype">id</span>, <a class="code" href="class_networking.html">Networking</a>* network, <span class="keyword">const</span> wxPoint&amp; pos, <span class="keywordtype">int</span> width, <span class="keywordtype">int</span> height, <span class="keyword">const</span> wxString&amp; name)
00021     : <a class="code" href="classwx_term.html">wxTerm</a>(parent, id, pos, width, height, name)
00022 {
00023     <a class="code" href="classwx_s_s_h.html#r0">m_connected</a> = <span class="keyword">false</span>;
00024     <a class="code" href="classwx_s_s_h.html#r2">m_networking</a> = network;
00025     <a class="code" href="classwx_s_s_h.html#r1">m_plinkStdIn</a> = <a class="code" href="_crc16_8h.html#a0">NULL</a>;
00026     <a class="code" href="classwx_s_s_h.html#r3">m_inputBuffer</a> = <span class="stringliteral">""</span>;
00027     <a class="code" href="classwx_s_s_h.html#r4">m_isInESCsequence</a> = <span class="keyword">false</span>;
00028     <a class="code" href="classwx_s_s_h.html#r5">m_startingDebugConnection</a> = <span class="keyword">false</span>;
00029 }
00030 
00031 
<a name="l00041"></a><a class="code" href="classwx_s_s_h.html#a1">00041</a> <a class="code" href="classwx_s_s_h.html#a1">wxSSH::~wxSSH</a>()
00042 {
00043     <span class="keywordflow">if</span>(<a class="code" href="classwx_s_s_h.html#r0">m_connected</a>)
00044     {
00045         <span class="comment">// "No time for pleasantries"</span>
00046         <a class="code" href="classwx_s_s_h.html#r2">m_networking</a>-&gt;<a class="code" href="class_networking.html#a16">ForceKillProcess</a>(<a class="code" href="classwx_s_s_h.html#r1">m_plinkStdIn</a>);
00047         wxUsleep(250);
00048         wxLogDebug(<span class="stringliteral">"wxSSH force killed m_plink."</span>);
00049     }
00050 }
00051 
00052 
<a name="l00066"></a><a class="code" href="classwx_s_s_h.html#a5">00066</a> <span class="keywordtype">void</span> <a class="code" href="classwx_s_s_h.html#a5">wxSSH::SendBack</a>(<span class="keywordtype">int</span> len, <span class="keywordtype">char</span> *data)
00067 {
00068     <span class="keywordflow">if</span>(<a class="code" href="classwx_s_s_h.html#r0">m_connected</a>) {
00069         wxString s(data, len); <span class="comment">// = "";</span>
00070         <a class="code" href="classwx_s_s_h.html#r1">m_plinkStdIn</a>-&gt;WriteString(s);
00071     }
00072 }
00073 
00074 
<a name="l00084"></a><a class="code" href="classwx_s_s_h.html#a6">00084</a> <span class="keywordtype">void</span> <a class="code" href="classwx_s_s_h.html#a6">wxSSH::Connect</a>()
00085 {
00086     <a class="code" href="classwx_s_s_h.html#r5">m_startingDebugConnection</a> = <span class="keyword">false</span>;
00087 
00088     <span class="keywordflow">if</span>(<a class="code" href="classwx_s_s_h.html#r0">m_connected</a>) {
00089         <a class="code" href="classwx_s_s_h.html#a8">Disconnect</a>(); <span class="comment">// might this be a problem because it's Asynchronous?</span>
00090     }
00091 
00092     <a class="code" href="class_g_term.html#a10">Reset</a>();
00093     <a class="code" href="class_g_term.html#a21">set_mode_flag</a>(CURSORINVISIBLE);
00094     Refresh();
00095 
00096     <span class="comment">// Start the new Process</span>
00097     <a class="code" href="classwx_s_s_h.html#r1">m_plinkStdIn</a> = <a class="code" href="classwx_s_s_h.html#r2">m_networking</a>-&gt;<a class="code" href="class_networking.html#a10">StartRemoteCommand</a>(<span class="stringliteral">"bash"</span>, <span class="keyword">this</span>);
00098     <span class="keywordflow">if</span>(<a class="code" href="classwx_s_s_h.html#r1">m_plinkStdIn</a> != <a class="code" href="_crc16_8h.html#a0">NULL</a>) {
00099         <a class="code" href="classwx_s_s_h.html#r0">m_connected</a> = <span class="keyword">true</span>;
00100         <a class="code" href="classwx_s_s_h.html#r3">m_inputBuffer</a> = <span class="stringliteral">""</span>;
00101         <a class="code" href="classwx_s_s_h.html#r4">m_isInESCsequence</a> = <span class="keyword">false</span>;
00102     }
00103 }
00104 
00105 
<a name="l00116"></a><a class="code" href="classwx_s_s_h.html#a7">00116</a> wxString <a class="code" href="classwx_s_s_h.html#a7">wxSSH::ConnectForDebug</a>()
00117 {
00118     <a class="code" href="classwx_s_s_h.html#r5">m_startingDebugConnection</a> = <span class="keyword">true</span>;
00119 
00120     <span class="keywordflow">if</span>(<a class="code" href="classwx_s_s_h.html#r0">m_connected</a>) {
00121         wxLogDebug(<span class="stringliteral">"Bad, Bad.  Tried starting as a debug terminal while already connected."</span>);
00122         <a class="code" href="classwx_s_s_h.html#a8">Disconnect</a>();
00123     }
00124 
00125     <a class="code" href="class_g_term.html#a10">Reset</a>();
00126     <a class="code" href="class_g_term.html#a21">set_mode_flag</a>(CURSORINVISIBLE);
00127     Refresh();
00128 
00129     <span class="comment">// Start the new Process</span>
00130     <a class="code" href="classwx_s_s_h.html#r1">m_plinkStdIn</a> = <a class="code" href="classwx_s_s_h.html#r2">m_networking</a>-&gt;<a class="code" href="class_networking.html#a10">StartRemoteCommand</a>(<span class="stringliteral">"who am i &amp;&amp; sleep 24h || echo \"CHdEBUGGER-CONNECT\""</span>, <span class="keyword">this</span>);
00131     <span class="keywordflow">if</span>(<a class="code" href="classwx_s_s_h.html#r1">m_plinkStdIn</a> != <a class="code" href="_crc16_8h.html#a0">NULL</a>) {
00132         <a class="code" href="classwx_s_s_h.html#r0">m_connected</a> = <span class="keyword">true</span>;
00133         <a class="code" href="classwx_s_s_h.html#r3">m_inputBuffer</a> = <span class="stringliteral">""</span>;
00134         <a class="code" href="classwx_s_s_h.html#r4">m_isInESCsequence</a> = <span class="keyword">false</span>;
00135     }
00136 
00137     <span class="comment">// Synchronous:</span>
00138     wxRegEx reParseTTY(<span class="stringliteral">".+?\\s+(.+?)\\s+\\w{3}\\s+\\d+\\s+\\d+:\\d+\\s"</span>, wxRE_ADVANCED);
00139     <span class="keywordflow">while</span>(!reParseTTY.Matches(<a class="code" href="classwx_s_s_h.html#r3">m_inputBuffer</a>) &amp;&amp; 
00140         !<a class="code" href="classwx_s_s_h.html#r3">m_inputBuffer</a>.Contains(<span class="stringliteral">"CHdEBUGGER-CONNECT"</span>)) {
00141         wxSafeYield(); <span class="comment">// yes, mark probably won't like this, but darn it's simple, and works</span>
00142     }
00143 
00144     wxString tty = reParseTTY.GetMatch(<a class="code" href="classwx_s_s_h.html#r3">m_inputBuffer</a>, 1); <span class="comment">// empty string is return if it fails</span>
00145 
00146     <a class="code" href="classwx_s_s_h.html#r3">m_inputBuffer</a> = <span class="stringliteral">""</span>;
00147     <a class="code" href="classwx_s_s_h.html#r5">m_startingDebugConnection</a> = <span class="keyword">false</span>;
00148 
00149     <span class="keywordflow">return</span> tty;
00150 }
00151 
00152 
<a name="l00163"></a><a class="code" href="classwx_s_s_h.html#a8">00163</a> <span class="keywordtype">void</span> <a class="code" href="classwx_s_s_h.html#a8">wxSSH::Disconnect</a>(<span class="keywordtype">bool</span> clearDisplay)
00164 {
00165     <span class="keywordflow">if</span>(<a class="code" href="classwx_s_s_h.html#r0">m_connected</a>)
00166     {
00167         <a class="code" href="classwx_s_s_h.html#r2">m_networking</a>-&gt;<a class="code" href="class_networking.html#a16">ForceKillProcess</a>(<a class="code" href="classwx_s_s_h.html#r1">m_plinkStdIn</a>);
00168         
00169         <span class="comment">// Not sure if this is needed or not... if we've got problems on exit, we'll come back here</span>
00170         <span class="comment">//wxUsleep(250);</span>
00171         <a class="code" href="classwx_s_s_h.html#r0">m_connected</a> = <span class="keyword">false</span>;
00172 
00173         <span class="keywordflow">if</span>(clearDisplay) {
00174             <a class="code" href="class_g_term.html#a10">GTerm::Reset</a>();
00175             <a class="code" href="class_g_term.html#a21">set_mode_flag</a>(CURSORINVISIBLE);
00176             <a class="code" href="class_g_term.html#a8">GTerm::Update</a>();
00177             Refresh();
00178         }
00179         <span class="keywordflow">else</span> {
00180             <a class="code" href="class_g_term.html#a21">set_mode_flag</a>(CURSORINVISIBLE);
00181         }
00182     }
00183 }
00184 
00185 
<a name="l00194"></a><a class="code" href="classwx_s_s_h.html#a9">00194</a> <span class="keywordtype">bool</span> <a class="code" href="classwx_s_s_h.html#a9">wxSSH::IsConnected</a>(<span class="keywordtype">void</span>)
00195 {
00196     <span class="keywordflow">return</span> <a class="code" href="classwx_s_s_h.html#r0">m_connected</a>;
00197 }
00198 
00199 
<a name="l00220"></a><a class="code" href="classwx_s_s_h.html#a2">00220</a> <span class="keywordtype">void</span> <a class="code" href="classwx_s_s_h.html#a2">wxSSH::OnPlinkOut</a>(<a class="code" href="class_chameleon_process_event.html">ChameleonProcessEvent</a> &amp;e)
00221 {
00222     wxString s = e.<a class="code" href="class_chameleon_process_event.html#a4">GetString</a>();
00223     <span class="keywordtype">int</span> len = s.Length();
00224 
00225     wxString startEscSeq0 = wxString((<span class="keywordtype">char</span>)27) + <span class="stringliteral">"]0;"</span>;
00226     <span class="comment">//wxString startEscSeq1 = wxEmptyString + (char)27 + "1;";</span>
00227     <span class="comment">//wxString startEscSeq2 = wxEmptyString + (char)27 + "2;";</span>
00228 
00229     <span class="keywordtype">int</span> start = s.Find(startEscSeq0);
00230     <span class="keywordflow">if</span>(start != -1) {
00231         <span class="keywordtype">int</span> end = s.Find((<span class="keywordtype">char</span>)7);
00232         <span class="keywordflow">if</span>(end &gt; start) {
00233             s.Remove(start, end-start);
00234             len -= (end-start);
00235         }
00236     }
00237 
00238     <span class="keywordflow">if</span>(!<a class="code" href="classwx_s_s_h.html#r4">m_isInESCsequence</a> &amp;&amp; !<a class="code" href="classwx_s_s_h.html#r5">m_startingDebugConnection</a>) { <span class="comment">// &amp;&amp; !s.Contains((char)27)) {</span>
00239         <a class="code" href="classwx_term.html#a27">ProcessInput</a>(len, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)s.c_str());
00240     }
00241     <span class="keywordflow">else</span> {
00242         <a class="code" href="classwx_s_s_h.html#r3">m_inputBuffer</a> += s;
00243     }
00244 
00245     <span class="keywordflow">return</span>;
00246 }
00247 
00248 
<a name="l00260"></a><a class="code" href="classwx_s_s_h.html#a3">00260</a> <span class="keywordtype">void</span> <a class="code" href="classwx_s_s_h.html#a3">wxSSH::OnPlinkErr</a>(<a class="code" href="class_chameleon_process_event.html">ChameleonProcessEvent</a> &amp;e)
00261 {
00262     wxLogDebug(<span class="stringliteral">"Terminal-StdError: "</span>+e.<a class="code" href="class_chameleon_process_event.html#a4">GetString</a>());
00263 }
00264 
00265 
<a name="l00279"></a><a class="code" href="classwx_s_s_h.html#a4">00279</a> <span class="keywordtype">void</span> <a class="code" href="classwx_s_s_h.html#a4">wxSSH::OnPlinkTerm</a>(<a class="code" href="class_chameleon_process_event.html">ChameleonProcessEvent</a> &amp;e)
00280 {
00281     wxLogDebug(<span class="stringliteral">"Terminal's External Process Terminated!"</span>);
00282 
00283     <a class="code" href="classwx_s_s_h.html#r0">m_connected</a> = <span class="keyword">false</span>;
00284 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 28 16:45:38 2004 for Chameleon by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
