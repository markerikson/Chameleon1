<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Chameleon: networking.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>networking.cpp</h1><a href="networking_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">// //////////////////////////////////////////////////</span>
00002 <span class="comment">//</span>
00003 <span class="comment">//   Notes:  All external methods call SSH___ methods after dealing with</span>
00004 <span class="comment">//               any caching or changes in host/user/pass.  It also deals</span>
00005 <span class="comment">//               with setting the statusDetails.</span>
00006 <span class="comment">//</span>
00007 <span class="comment">//   ToDo: pull process stuff out of here</span>
00008 <span class="comment">//</span>
00009 <span class="comment">// //////////////////////////////////////////////////</span>
00010 <span class="preprocessor">#include &lt;wx/regex.h&gt;</span> <span class="comment">// for finding the host fingerprint</span>
00011 <span class="preprocessor">#include &lt;wx/file.h&gt;</span>
00012 <span class="preprocessor">#include &lt;wx/process.h&gt;</span>
00013 <span class="preprocessor">#include &lt;wx/txtstrm.h&gt;</span>
00014 <span class="preprocessor">#include "<a class="code" href="networking_8h.html">networking.h</a>"</span>
00015 <span class="preprocessor">#include "<a class="code" href="plinkconnect_8h.html">plinkconnect.h</a>"</span>
00016 <span class="preprocessor">#include "../common/datastructures.h"</span>
00017 <span class="preprocessor">#include "../common/Options.h"</span>
00018 <span class="preprocessor">#include "../common/debug.h"</span>
00019 
00020 <span class="preprocessor">#ifdef _DEBUG</span>
00021 <span class="preprocessor"></span><span class="preprocessor">    #define new DEBUG_NEW</span>
00022 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00023 <span class="preprocessor"></span>
00024 BEGIN_EVENT_TABLE(<a class="code" href="class_networking.html">Networking</a>, wxEvtHandler)
00025     EVT_TIMER(-1, Networking::onTimerTick)
00026     EVT_END_PROCESS(-1, Networking::onTerm)
00027 END_EVENT_TABLE()
00028 
00029 
00030 
00031 
00032 
00033 
00034 
00035 
00036 
00037 
00038 
<a name="l00039"></a><a class="code" href="class_networking.html#a0">00039</a> <a class="code" href="class_networking.html#a0">Networking::Networking</a>(<a class="code" href="class_options.html">Options</a>* options)
00040 {
00041     m_options = options;
00042     <a class="code" href="class_networking.html#r2">m_currHost</a> = m_options-&gt;<a class="code" href="class_options.html#a17">GetHostname</a>();
00043     <a class="code" href="class_networking.html#r3">m_currUser</a> = m_options-&gt;<a class="code" href="class_options.html#a16">GetUsername</a>();
00044     <a class="code" href="class_networking.html#r4">m_currPass</a> = m_options-&gt;<a class="code" href="class_options.html#a18">GetPassphrase</a>();
00045 
00046     <span class="comment">//Timer:</span>
00047     m_timer.SetOwner(<span class="keyword">this</span>);
00048     <span class="keywordtype">bool</span> timerSuccess = m_timer.Start(<a class="code" href="networking_8h.html#a0">POLL_RATE</a>);
00049     <span class="keywordflow">if</span>(!timerSuccess) {
00050         wxLogDebug(<span class="stringliteral">"PlinkConnect could not get a timer.\n"</span>);
00051     }
00052 
00053     <span class="comment">//Plink:</span>
00054     <a class="code" href="class_networking.html#r0">m_plinks</a> = <span class="keyword">new</span> <a class="code" href="class_plink_connect.html">PlinkConnect</a>(m_options-&gt;<a class="code" href="class_options.html#a14">GetPlinkApp</a>(), <a class="code" href="class_networking.html#r2">m_currHost</a>,
00055                                 <a class="code" href="class_networking.html#r3">m_currUser</a>, <a class="code" href="class_networking.html#r4">m_currPass</a>);
00056 
00057     <a class="code" href="class_networking.html#r5">m_status</a> = <a class="code" href="datastructures_8h.html#a154a120">NET_STARTING</a>;
00058     <span class="comment">//GetStatus(); &lt;-- no need to be pre-emptive (here it's best not to be)</span>
00059 }
00060 
00061 
<a name="l00069"></a><a class="code" href="class_networking.html#a1">00069</a> <a class="code" href="class_networking.html#a1">Networking::~Networking</a>()
00070 {
00071     <span class="keyword">delete</span> <a class="code" href="class_networking.html#r0">m_plinks</a>;
00072 }
00073 
00074 
<a name="l00085"></a><a class="code" href="class_networking.html#a6">00085</a> <span class="keywordtype">bool</span> <a class="code" href="class_networking.html#a6">Networking::GetHomeDirPath</a>(wxString &amp;path)
00086 {
00087     <span class="keywordtype">bool</span> success = <span class="keyword">false</span>;
00088 
00089     <span class="keywordflow">if</span>(<a class="code" href="class_networking.html#a2">GetStatus</a>() == <a class="code" href="datastructures_8h.html#a154a121">NET_GOOD</a>) {
00090         <span class="comment">// mini-caching:</span>
00091         <span class="keywordflow">if</span>(<a class="code" href="class_networking.html#r7">m_userHomeDir</a> == wxEmptyString)
00092         {
00093             <span class="keywordflow">if</span>( <a class="code" href="class_networking.html#d2">SSHGetHomeDirPath</a>(path) ) {
00094                 <a class="code" href="class_networking.html#r7">m_userHomeDir</a> = path;
00095                 success = <span class="keyword">true</span>;
00096                 <a class="code" href="class_networking.html#r6">m_statusDetails</a> = <span class="stringliteral">""</span>;
00097             }
00098         }
00099         <span class="keywordflow">else</span> {
00100             <span class="comment">// pull for 'cache'</span>
00101             path = <a class="code" href="class_networking.html#r7">m_userHomeDir</a>;
00102             success = <span class="keyword">true</span>;
00103         }
00104     }
00105 
00106     <span class="keywordflow">return</span> success;
00107 }
00108 
00109 
<a name="l00121"></a><a class="code" href="class_networking.html#a7">00121</a> <span class="keywordtype">bool</span> <a class="code" href="class_networking.html#a7">Networking::GetFileContents</a>(wxFileName file, wxString &amp;contents)
00122 {
00123     <span class="keywordtype">bool</span> success = <span class="keyword">false</span>;
00124 
00125     <span class="keywordflow">if</span>(<a class="code" href="class_networking.html#a2">GetStatus</a>() == <a class="code" href="datastructures_8h.html#a154a121">NET_GOOD</a>) {
00126         <span class="keywordflow">if</span>( <a class="code" href="class_networking.html#d3">SSHGetFileContents</a>(file.GetFullPath(wxPATH_UNIX), contents) ) {
00127             <a class="code" href="class_networking.html#r6">m_statusDetails</a> = <span class="stringliteral">""</span>;
00128             success = <span class="keyword">true</span>;
00129         }
00130     }
00131 
00132     <span class="keywordflow">return</span> success;
00133 }
00134 
00135 
<a name="l00149"></a><a class="code" href="class_networking.html#a8">00149</a> <span class="keywordtype">bool</span> <a class="code" href="class_networking.html#a8">Networking::SendFileContents</a>(wxString strng, wxFileName file)
00150 {
00151     <span class="keywordtype">bool</span> success = <span class="keyword">false</span>;
00152 
00153     <span class="keywordflow">if</span>(<a class="code" href="class_networking.html#a2">GetStatus</a>() == <a class="code" href="datastructures_8h.html#a154a121">NET_GOOD</a>) {
00154         <span class="comment">// Save the file someplace:</span>
00155         wxString fname = wxFileName::CreateTempFileName(<span class="stringliteral">"chm"</span>); <span class="comment">// chm?????.tmp</span>
00156         <span class="keywordflow">if</span>(fname != <span class="stringliteral">""</span>) {
00157             wxFile f(fname, wxFile::write);
00158             <span class="keywordflow">if</span>(f.IsOpened()) {
00159                 <span class="keywordtype">bool</span> written = f.Write(strng);
00160                 f.Close();
00161                 <span class="keywordflow">if</span>(written) {
00162                     <span class="comment">// YEAH!, now I can send the file</span>
00163                     <span class="keywordflow">if</span>( <a class="code" href="class_networking.html#d4">SCPDoTransfer</a>(fname, file.GetFullPath(wxPATH_UNIX)) ) {
00164                         success = <span class="keyword">true</span>;
00165                         <a class="code" href="class_networking.html#r6">m_statusDetails</a> = <span class="stringliteral">""</span>;
00166                     }
00167 
00168                     <span class="comment">// Remove the temp file:</span>
00169                     wxRemoveFile(fname);
00170                 }
00171                 <span class="keywordflow">else</span> {
00172                     <span class="comment">//success = false;</span>
00173                     <a class="code" href="class_networking.html#r6">m_statusDetails</a> = <span class="stringliteral">"Could not write to the temp file "</span> + fname;
00174                 }
00175             }
00176             <span class="keywordflow">else</span> {
00177                 <span class="comment">//success = false;</span>
00178                 <a class="code" href="class_networking.html#r6">m_statusDetails</a> = <span class="stringliteral">"Could not open the temp file "</span> + fname;
00179             }
00180         }
00181         <span class="keywordflow">else</span> {
00182             <span class="comment">//success = false;</span>
00183             <a class="code" href="class_networking.html#r6">m_statusDetails</a> = <span class="stringliteral">"Could not create a temp file"</span>;
00184         }
00185     }
00186 
00187     <span class="keywordflow">return</span> success;
00188 }
00189 
00190 
<a name="l00207"></a><a class="code" href="class_networking.html#a9">00207</a> <span class="keywordtype">bool</span> <a class="code" href="class_networking.html#a9">Networking::GetDirListing</a>(wxString dirPath, <a class="code" href="struct_dir_listing.html">DirListing</a> &amp;listing, <span class="keywordtype">bool</span> forceRefresh,
00208                                <span class="keywordtype">bool</span> includeHidden)
00209 {
00210     <span class="keywordtype">bool</span> success = <span class="keyword">false</span>;
00211 
00212     <span class="keywordflow">if</span>(<a class="code" href="class_networking.html#a2">GetStatus</a>() == <a class="code" href="datastructures_8h.html#a154a121">NET_GOOD</a>) {
00213         <span class="comment">// internally manage dirListing caches to increase speed</span>
00214         <span class="comment">//if(in cache) {</span>
00215         <span class="comment">//  blah</span>
00216         <span class="comment">//}</span>
00217         <span class="comment">//else</span>
00218         <span class="keywordflow">if</span>( <a class="code" href="class_networking.html#d5">SSHGetDirListing</a>(dirPath, listing, includeHidden) ) {
00219             <a class="code" href="class_networking.html#r6">m_statusDetails</a> = <span class="stringliteral">""</span>;
00220             success = <span class="keyword">true</span>;
00221         }
00222     }
00223     
00224     <span class="keywordflow">return</span> success;
00225 }
00226 
00227 
00239 <span class="comment">//Private:</span>
<a name="l00240"></a><a class="code" href="class_networking.html#d2">00240</a> <span class="keywordtype">bool</span> <a class="code" href="class_networking.html#d2">Networking::SSHGetHomeDirPath</a>(wxString &amp;path) {
00241     wxString cmd = <span class="stringliteral">"cd ~ &amp;&amp; pwd"</span>;
00242     
00243     wxString output;
00244 
00245     <span class="keywordflow">if</span>( <a class="code" href="class_networking.html#d8">SSHExecSyncCommand</a>(cmd, output) ) {
00246         output.Remove(output.Length()-2); <span class="comment">// remove pwd's EOL("\r\n")</span>
00247         path = output;
00248         <a class="code" href="class_networking.html#r6">m_statusDetails</a> = <span class="stringliteral">""</span>;
00249         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00250     }
00251     <span class="comment">//else</span>
00252         <a class="code" href="class_networking.html#r6">m_statusDetails</a> = output;
00253         path = <span class="stringliteral">"~"</span>;
00254         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00255 }
00256 
00257 
00269 <span class="comment">//Private:</span>
<a name="l00270"></a><a class="code" href="class_networking.html#d3">00270</a> <span class="keywordtype">bool</span> <a class="code" href="class_networking.html#d3">Networking::SSHGetFileContents</a>(wxString file, wxString &amp;contents)
00271 {
00272     wxString cmd = <span class="stringliteral">"cat "</span> + file;
00273     wxString output;
00274 
00275     <span class="keywordflow">if</span>( <a class="code" href="class_networking.html#d8">SSHExecSyncCommand</a>(cmd, output) ) {
00276 
00278         output.Replace(<span class="stringliteral">"\r\n"</span>, <span class="stringliteral">"\n"</span>, <span class="keyword">true</span>);
00280 
00281         contents = output;
00282         <a class="code" href="class_networking.html#r6">m_statusDetails</a> = <span class="stringliteral">""</span>;
00283         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00284     }
00285     <span class="comment">//else</span>
00286         <a class="code" href="class_networking.html#r6">m_statusDetails</a> = output;
00287         contents = <span class="stringliteral">""</span>;
00288         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00289 
00290 }
00291 
00292 
00310 <span class="comment">//Private:</span>
<a name="l00311"></a><a class="code" href="class_networking.html#d4">00311</a> <span class="keywordtype">bool</span> <a class="code" href="class_networking.html#d4">Networking::SCPDoTransfer</a>(wxString from_path_name, wxString to_path_name)
00312 {
00313     <span class="comment">// right now this only does local -&gt; remote transfers</span>
00314     wxString cmd = m_options-&gt;<a class="code" href="class_options.html#a13">GetPscpApp</a>() <span class="comment">// + " -l " + ssh_user </span>
00315                     + <span class="stringliteral">" -pw "</span> + <a class="code" href="class_networking.html#r4">m_currPass</a> + <span class="stringliteral">" -batch "</span>
00316                     + from_path_name + <span class="stringliteral">" "</span> 
00317                     + <a class="code" href="class_networking.html#r3">m_currUser</a> + <span class="stringliteral">"</span><span class="stringliteral">@" + m_currHost + "</span>:" + to_path_name;
00318                     <span class="comment">//+ " &amp;&amp; echo Chameleon-Transfer-Success";</span>
00319     wxProcess* proc = <span class="keyword">new</span> wxProcess();
00320     proc-&gt;Redirect();
00321     <span class="keywordtype">int</span> exitcode = wxExecute(cmd, wxEXEC_SYNC, proc);
00322 
00323     <span class="comment">// Determine success:</span>
00324     <span class="keywordtype">bool</span> success = <span class="keyword">false</span>;
00325 
00326     <span class="keywordflow">if</span>(exitcode == -1) { <span class="comment">// Bad Exit -- Could not start process</span>
00327         <a class="code" href="class_networking.html#r6">m_statusDetails</a> = <span class="stringliteral">"Could not start the file transfer process."</span>;
00328         <span class="comment">//success = false;</span>
00329     }
00330     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(exitcode == 0) {
00331         <span class="comment">// Assumed good</span>
00332         success = <span class="keyword">true</span>;
00333         <a class="code" href="class_networking.html#r6">m_statusDetails</a> = <span class="stringliteral">""</span>;
00334     }
00335     <span class="keywordflow">else</span> { <span class="comment">// Not bad Exit(hopefully good):</span>
00336         <span class="comment">// Grab the outputs:</span>
00337         wxString output = <span class="stringliteral">""</span>;
00338         wxString errlog = <span class="stringliteral">""</span>;
00339         wxInputStream* rin = proc-&gt;GetInputStream();
00340         wxInputStream* rerr = proc-&gt;GetErrorStream();
00341         <span class="keywordflow">while</span>(!rin-&gt;Eof()) {
00342             output += rin-&gt;GetC();
00343         }
00344         <span class="keywordflow">while</span>(!rerr-&gt;Eof()) {
00345             errlog += rerr-&gt;GetC();
00346         }
00347 
00348         <span class="comment">// Determine the success:</span>
00349         <span class="keywordflow">if</span>(output.Contains(<span class="stringliteral">"Chameleon-Transfer-Success"</span>)) {
00350             success = <span class="keyword">true</span>;
00351             <a class="code" href="class_networking.html#r6">m_statusDetails</a> = <span class="stringliteral">""</span>;
00352         }
00353         <span class="keywordflow">else</span> {
00354             <a class="code" href="class_networking.html#r6">m_statusDetails</a> = output + errlog;
00355         }
00356     }
00357     <span class="keyword">delete</span> proc;
00358 
00359     <span class="keywordflow">return</span> success;
00360 }
00361 
00362 
00380 <span class="comment">//Private:</span>
<a name="l00381"></a><a class="code" href="class_networking.html#d5">00381</a> <span class="keywordtype">bool</span> <a class="code" href="class_networking.html#d5">Networking::SSHGetDirListing</a>(wxString dirPath, <a class="code" href="struct_dir_listing.html">DirListing</a> &amp;listing,
00382                                     <span class="keywordtype">bool</span> includeHidden)
00383 {
00384     wxString cmd = <span class="stringliteral">"cd "</span> + dirPath
00385                     + <span class="stringliteral">" &amp;&amp; find -maxdepth 1 -type f "</span>
00386                     + <span class="stringliteral">" &amp;&amp; echo N_E_TwOrKiNg-DiRs"</span>
00387                     + <span class="stringliteral">" &amp;&amp; find -maxdepth 1 -type d"</span>;
00388     wxString output;
00389     
00390     <span class="keywordflow">if</span>( <a class="code" href="class_networking.html#d8">SSHExecSyncCommand</a>(cmd, output) ) {
00391         <span class="comment">// if returned true, the token will be there</span>
00392         <span class="keywordtype">int</span> tokenPos = output.Find(<span class="stringliteral">"N_E_TwOrKiNg-DiRs\r\n"</span>);
00393         wxString files = output.Left(tokenPos); <span class="comment">// +1</span>
00394         wxString dirs = output.Mid(tokenPos+19);
00395 
00396         listing.<a class="code" href="struct_dir_listing.html#o1">fileNames</a> = <a class="code" href="class_networking.html#d7">ParseFindOutput</a>(files, includeHidden);
00397         listing.<a class="code" href="struct_dir_listing.html#o0">dirNames</a> = <a class="code" href="class_networking.html#d7">ParseFindOutput</a>(dirs, includeHidden);
00398 
00399         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00400     }
00401     <span class="comment">//else</span>
00402         <a class="code" href="class_networking.html#r6">m_statusDetails</a> = output;
00403         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00404 }
00405 
00406 
00423 <span class="comment">//Private:</span>
<a name="l00424"></a><a class="code" href="class_networking.html#d7">00424</a> wxArrayString <a class="code" href="class_networking.html#d7">Networking::ParseFindOutput</a>(wxString strng, <span class="keywordtype">bool</span> includeHidden)
00425 {
00426     wxArrayString r;
00427     r.Empty();
00428 
00429     <span class="keywordflow">while</span>(strng.Length() &gt; 2) {
00430 
00431         <span class="comment">// Get the "./"</span>
00432         <span class="keywordtype">char</span> c1 = strng.GetChar(0); <span class="comment">// peek</span>
00433         <span class="keywordtype">char</span> c2 = strng.GetChar(1); <span class="comment">// peek</span>
00434         strng.Remove(0,2); <span class="comment">// pop</span>
00435 
00436         <span class="keywordflow">if</span>(c1 == <span class="charliteral">'.'</span> &amp;&amp; c2 == <span class="charliteral">'\r'</span>) {
00437             <span class="comment">// Special case for . direcrtory</span>
00438             strng = <span class="stringliteral">"\r"</span> + strng; <span class="comment">// push it back on</span>
00439             c2 = <span class="charliteral">'/'</span>;
00440         }
00441 
00442         <span class="comment">//if(c1 != '.' &amp;&amp; c2 != '/') {</span>
00443         <span class="comment">//  return r; // unexpected</span>
00444         <span class="comment">//}</span>
00445 
00446         <span class="comment">// Queue-up/Initialize for the loop</span>
00447         <span class="comment">// There should be at least 2 left: \r\n        </span>
00448         c1 = strng.GetChar(0);
00449         c2 = strng.GetChar(1);
00450         strng.Remove(0,2);
00451 
00452         wxString newitem = <span class="stringliteral">""</span>;
00453 
00454         <span class="keywordflow">while</span>(c1 != <span class="charliteral">'\r'</span> &amp;&amp; c2 != <span class="charliteral">'\n'</span>) {
00455             newitem += c1;
00456             c1 = c2;
00457             c2 = strng.GetChar(0); <span class="comment">// peek</span>
00458             strng.Remove(0,1); <span class="comment">// pop</span>
00459         }
00460 
00461         <span class="keywordflow">if</span>(newitem != <span class="stringliteral">""</span>) {
00462             <span class="keywordflow">if</span>(newitem.Left(1) != <span class="stringliteral">"."</span> || includeHidden) {
00463                 r.Add(newitem);
00464             }
00465         }
00466     }
00467 
00468     <span class="keywordflow">return</span> r;
00469 }
00470 
00471 
00484 <span class="comment">//Private:</span>
<a name="l00485"></a><a class="code" href="class_networking.html#d8">00485</a> <span class="keywordtype">bool</span> <a class="code" href="class_networking.html#d8">Networking::SSHExecSyncCommand</a>(wxString command, wxString &amp;output) {
00486     command += <span class="stringliteral">" &amp;&amp; echo Su_CC_ess-CMD"</span>;
00487 
00488     output = <a class="code" href="class_networking.html#r0">m_plinks</a>-&gt;<a class="code" href="class_plink_connect.html#a3">executeSyncCommand</a>(command);
00489 
00490     <span class="keywordtype">int</span> tokenPos = output.Find(<span class="stringliteral">"Su_CC_ess-CMD"</span>);
00491     <span class="keywordflow">if</span>(tokenPos != -1) {
00492         output.Remove(tokenPos);
00493         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00494     }
00495     <span class="comment">// else</span>
00496         <span class="keywordflow">return</span> <span class="keyword">false</span>;   
00497 }
00498 
00499 
00511 <span class="comment">//Private:</span>
<a name="l00512"></a><a class="code" href="class_networking.html#d6">00512</a> <span class="keywordtype">bool</span> <a class="code" href="class_networking.html#d6">Networking::MaintainSettings</a>() {
00513     wxString newH = m_options-&gt;<a class="code" href="class_options.html#a17">GetHostname</a>();
00514     wxString newU = m_options-&gt;<a class="code" href="class_options.html#a16">GetUsername</a>();
00515     wxString newP = m_options-&gt;<a class="code" href="class_options.html#a18">GetPassphrase</a>();
00516 
00517     <span class="keywordflow">if</span>(newH != <a class="code" href="class_networking.html#r2">m_currHost</a> || newU != <a class="code" href="class_networking.html#r3">m_currUser</a> || newP != <a class="code" href="class_networking.html#r4">m_currPass</a> ) {
00518         <span class="comment">// I don't check for plinkApp changes because I don't keep track of those</span>
00519         <span class="comment">// Something has changed</span>
00520         <a class="code" href="class_networking.html#r2">m_currHost</a> = newH;
00521         <a class="code" href="class_networking.html#r3">m_currUser</a> = newU;
00522         <a class="code" href="class_networking.html#r4">m_currPass</a> = newP;
00523 
00524         <span class="comment">//Update PlinkConnect</span>
00525         <a class="code" href="class_networking.html#r0">m_plinks</a>-&gt;<a class="code" href="class_plink_connect.html#a6">setLogin</a>(newH, newU, newP); <span class="comment">// this restarts the network</span>
00526         <a class="code" href="class_networking.html#r5">m_status</a> = <a class="code" href="datastructures_8h.html#a154a120">NET_STARTING</a>;
00527 
00528         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00529     }
00530     <span class="comment">//else</span>
00531       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00532 
00533 }
00534 
00535 
<a name="l00550"></a><a class="code" href="class_networking.html#a2">00550</a> <a class="code" href="datastructures_8h.html#a154">NetworkStatus</a> <a class="code" href="class_networking.html#a2">Networking::GetStatus</a>()
00551 {
00552     <span class="keywordflow">if</span>(<a class="code" href="class_networking.html#d6">MaintainSettings</a>() || <a class="code" href="class_networking.html#r5">m_status</a> == <a class="code" href="datastructures_8h.html#a154a120">NET_STARTING</a>) {
00553         <span class="comment">// Update the status</span>
00554         <span class="keywordflow">if</span>(<a class="code" href="class_networking.html#r0">m_plinks</a>-&gt;<a class="code" href="class_plink_connect.html#a7">getIsConnected</a>()) {
00555             <a class="code" href="class_networking.html#r5">m_status</a> = <a class="code" href="datastructures_8h.html#a154a121">NET_GOOD</a>;
00556         }
00557         <span class="keywordflow">else</span> {
00558             wxString message = <a class="code" href="class_networking.html#r0">m_plinks</a>-&gt;<a class="code" href="class_plink_connect.html#a9">getMessage</a>();
00559 
00560             <a class="code" href="class_networking.html#r5">m_status</a> = <a class="code" href="datastructures_8h.html#a154a125">NET_ERROR_MESSAGE</a>; <span class="comment">//default</span>
00561             <a class="code" href="class_networking.html#r6">m_statusDetails</a> = message;
00562 
00563             <span class="keywordflow">if</span>(message.Contains(<span class="stringliteral">"key is not cached"</span>)) {
00564                 <span class="comment">// host finger print not in cache</span>
00565                 <a class="code" href="class_networking.html#r5">m_status</a> = <a class="code" href="datastructures_8h.html#a154a122">NET_UNKNOWN_HOST</a>;
00566 
00567                 <span class="comment">// Grab the Fingerprint:</span>
00568                 wxRegEx reFingerprint = <span class="stringliteral">"[[:digit:]]+[[:blank:]]+([[:xdigit:]]{2}:)+[[:xdigit:]]{2}"</span>;
00569 
00570                 <span class="keywordflow">if</span>(reFingerprint.Matches(message))
00571                 {
00572                     <span class="comment">//wxString match = reFingerprint.GetMatch(message);</span>
00573                     <span class="comment">//wxLogDebug("Matched fingerprint: \"%s\"", match);</span>
00574                     <a class="code" href="class_networking.html#r6">m_statusDetails</a> = reFingerprint.GetMatch(message);
00575                 }
00576                 <span class="keywordflow">else</span>
00577                 {
00578                     <span class="comment">//wxLogDebug("Failed to match the fingerprint in: %s", errlog);</span>
00579                     <a class="code" href="class_networking.html#r6">m_statusDetails</a> = <span class="stringliteral">"*unknown* - could not parse fingerprint"</span>;
00580                 }
00581             }
00582             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(message.Contains(<span class="stringliteral">"Unable to authenticate"</span>)) {
00583                 <span class="comment">// user+pass did not work on host</span>
00584                 <a class="code" href="class_networking.html#r5">m_status</a> = <a class="code" href="datastructures_8h.html#a154a124">NET_AUTH_FAILED</a>;
00585             }
00586             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(message.Contains(<span class="stringliteral">"Connection refused"</span>)) {
00587                 <span class="comment">// host wouldn't allow a connection</span>
00588                 <a class="code" href="class_networking.html#r5">m_status</a> = <a class="code" href="datastructures_8h.html#a154a123">NET_CONN_REFUSED</a>;
00589             }
00590         }
00591     }
00592     <span class="keywordflow">return</span> <a class="code" href="class_networking.html#r5">m_status</a>;
00593 }
00594 
00595 
<a name="l00609"></a><a class="code" href="class_networking.html#a3">00609</a> wxString <a class="code" href="class_networking.html#a3">Networking::GetStatusDetails</a>()
00610 {
00611     <span class="keywordflow">return</span> <a class="code" href="class_networking.html#r6">m_statusDetails</a>;
00612 }
00613 
00614 
<a name="l00627"></a><a class="code" href="class_networking.html#a4">00627</a> <span class="keywordtype">void</span> <a class="code" href="class_networking.html#a4">Networking::SSHCacheFingerprint</a>()
00628 {
00629     <span class="comment">//Start the program asynchonously, answer "y" to caching, then Kill it:</span>
00630     wxString cmd = m_options-&gt;<a class="code" href="class_options.html#a14">GetPlinkApp</a>() + <span class="stringliteral">" "</span> + <a class="code" href="class_networking.html#r2">m_currHost</a>;
00631     wxProcess* proc = <span class="keyword">new</span> wxProcess(<a class="code" href="_crc16_8h.html#a0">NULL</a>);
00632     proc-&gt;Redirect();
00633     <span class="keywordtype">long</span> pid = wxExecute(cmd, wxEXEC_ASYNC, proc);
00634     wxTextOutputStream pout(*proc-&gt;GetOutputStream(), wxEOL_UNIX);
00635     pout &lt;&lt; <span class="stringliteral">"y\n"</span>;
00636 
00637     <span class="comment">// Sending wxSIGTERM should close it out gracefully, but it doesn't terminate (ODD)</span>
00638     <span class="comment">// And, sending SIGKILL too soon ends the process before it caches the fingerprint</span>
00639     <span class="comment">// So, pause for 1/4 a second, then send SIGKILL</span>
00640     wxUsleep(250);
00641     wxKill(pid, wxSIGKILL);
00642 
00643     <a class="code" href="class_networking.html#r0">m_plinks</a>-&gt;<a class="code" href="class_plink_connect.html#a6">setLogin</a>(<span class="stringliteral">""</span>,<span class="stringliteral">""</span>,<span class="stringliteral">""</span>); <span class="comment">// terminate all connections, and do a spawn</span>
00644     <a class="code" href="class_networking.html#r5">m_status</a> = <a class="code" href="datastructures_8h.html#a154a120">NET_STARTING</a>;
00645 
00646     <span class="comment">// It also takes care of deleting the process, so we don't have to do that manually.</span>
00647     <span class="comment">//delete proc; // self-destructs</span>
00648 }
00649 
00650 
<a name="l00660"></a><a class="code" href="class_networking.html#a5">00660</a> <span class="keywordtype">void</span> <a class="code" href="class_networking.html#a5">Networking::PingOptions</a>() {
00661     <span class="comment">// This function must NOT be SYNCHRONOUS</span>
00662     <span class="comment">//  (especially not locking -- wxSafeYield)</span>
00663 
00664     <span class="comment">// If nothing has changed, nothing will happen.</span>
00665     <span class="keywordflow">if</span>( <a class="code" href="class_networking.html#d6">MaintainSettings</a>() || <a class="code" href="class_networking.html#r5">m_status</a> == <a class="code" href="datastructures_8h.html#a154a120">NET_STARTING</a>) {
00666         <span class="comment">// If settings have changed, the changes will be propagated to PlinkConnect,</span>
00667         <span class="comment">//     then (asynchronously) PlinkConnect will spawn a connection (if possible)</span>
00668         <span class="keywordflow">if</span>(<a class="code" href="class_networking.html#r0">m_plinks</a>-&gt;<a class="code" href="class_plink_connect.html#a8">getIsSettled</a>()) {
00669             <span class="comment">// only do this if I know I will can an immediate response</span>
00670             <a class="code" href="class_networking.html#a2">GetStatus</a>();
00671         }
00672     }
00673 }
00674 
00675 
00676 
00677 
00678 <span class="comment">//============================================================================</span>
00679 <span class="comment">//                        PROCESS MANAGEMENT stuff</span>
00680 <span class="comment">//============================================================================</span>
00681 
00682 
00683 
00684 
<a name="l00699"></a><a class="code" href="class_networking.html#a15">00699</a> wxTextOutputStream* <a class="code" href="class_networking.html#a15">Networking::StartCommand</a>(<span class="keywordtype">bool</span> isRemote, wxString cmd,
00700                                              wxEvtHandler* owner)
00701 {
00702     <span class="keywordflow">if</span>(isRemote) {
00703         <span class="keywordflow">return</span> <a class="code" href="class_networking.html#a10">StartRemoteCommand</a>(cmd, owner);
00704     }
00705     <span class="keywordflow">else</span> {
00706         <span class="keywordflow">return</span> <a class="code" href="class_networking.html#a11">StartLocalCommand</a>(cmd, owner);
00707     }
00708 }
00709 
00710 
<a name="l00723"></a><a class="code" href="class_networking.html#a10">00723</a> wxTextOutputStream* <a class="code" href="class_networking.html#a10">Networking::StartRemoteCommand</a>(wxString cmd, wxEvtHandler* owner)
00724 {
00725     <span class="keywordflow">return</span> <a class="code" href="class_networking.html#r0">m_plinks</a>-&gt;<a class="code" href="class_plink_connect.html#a2">executeCommand</a>(cmd, owner);
00726 }
00727 
00728 
<a name="l00740"></a><a class="code" href="class_networking.html#a11">00740</a> wxTextOutputStream* <a class="code" href="class_networking.html#a11">Networking::StartLocalCommand</a>(wxString cmd, wxEvtHandler* owner)
00741 {
00742     wxLogDebug(<span class="stringliteral">"Local Process Execution still missing."</span>);
00743     <span class="keywordflow">return</span> <a class="code" href="_crc16_8h.html#a0">NULL</a>;
00744 }
00745 
00746 
<a name="l00760"></a><a class="code" href="class_networking.html#a14">00760</a> wxString <a class="code" href="class_networking.html#a14">Networking::ExecuteCommand</a>(<span class="keywordtype">bool</span> isRemote, wxString cmd)
00761 {
00762     <span class="keywordflow">if</span>(isRemote) {
00763         <span class="keywordflow">return</span> <a class="code" href="class_networking.html#a12">ExecuteRemoteCommand</a>(cmd);
00764     }
00765     <span class="keywordflow">else</span> {
00766         <span class="keywordflow">return</span> <a class="code" href="class_networking.html#a13">ExecuteLocalCommand</a>(cmd);
00767     }
00768 }
00769 
00770 
<a name="l00781"></a><a class="code" href="class_networking.html#a12">00781</a> wxString <a class="code" href="class_networking.html#a12">Networking::ExecuteRemoteCommand</a>(wxString cmd)
00782 {
00783     <span class="keywordflow">return</span> <a class="code" href="class_networking.html#r0">m_plinks</a>-&gt;<a class="code" href="class_plink_connect.html#a3">executeSyncCommand</a>(cmd);
00784 }
00785 
00786 
<a name="l00797"></a><a class="code" href="class_networking.html#a13">00797</a> wxString <a class="code" href="class_networking.html#a13">Networking::ExecuteLocalCommand</a>(wxString cmd)
00798 {
00799     wxLogDebug(<span class="stringliteral">"Local Synchronous Process Execution still missing."</span>);
00800     <span class="keywordflow">return</span> wxEmptyString;
00801 }
00802 
00803 
<a name="l00815"></a><a class="code" href="class_networking.html#a16">00815</a> <span class="keywordtype">void</span> <a class="code" href="class_networking.html#a16">Networking::ForceKillProcess</a>(wxTextOutputStream* w)
00816 {
00817     <span class="comment">//Walk m_processes:</span>
00818     <span class="keywordtype">bool</span> isLocal = <span class="keyword">false</span>;
00819     <span class="comment">//for(ProcessInfoList::Node* node = m_processes.GetFirst(); node; node = node-&gt;GetNext() ) {</span>
00820     <span class="comment">//  p = node-&gt;GetData();</span>
00821     <span class="comment">//  if(p-&gt;pid == pid) {</span>
00822     <span class="comment">//      isLocal = true;</span>
00823     <span class="comment">//      break;</span>
00824     <span class="comment">//  }</span>
00825     <span class="comment">//}</span>
00826 
00827     <span class="keywordflow">if</span>(isLocal) {
00828         <span class="comment">//</span>
00829     }
00830     <span class="keywordflow">else</span> {
00831         <a class="code" href="class_networking.html#r0">m_plinks</a>-&gt;<a class="code" href="class_plink_connect.html#a4">ForceKillProcess</a>(w);
00832     }
00833 }
00834 
00835 
00836 <span class="comment">//Private:</span>
<a name="l00837"></a><a class="code" href="class_networking.html#d0">00837</a> <span class="keywordtype">void</span> <a class="code" href="class_networking.html#d0">Networking::onTerm</a>(wxProcessEvent &amp;e) {
00838     <span class="comment">//</span>
00839 }
00840 
00841 
00842 <span class="comment">//Private:</span>
<a name="l00843"></a><a class="code" href="class_networking.html#d1">00843</a> <span class="keywordtype">void</span> <a class="code" href="class_networking.html#d1">Networking::onTimerTick</a>(wxTimerEvent &amp;e) {
00844     <span class="comment">//</span>
00845 
00846     <a class="code" href="class_networking.html#r0">m_plinks</a>-&gt;<a class="code" href="class_plink_connect.html#a5">PollTick</a>();
00847 }
00848 
00849 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 28 16:45:38 2004 for Chameleon by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
