<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Chameleon: gterm.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.6 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a></div>
<h1>gterm.cpp</h1><a href="gterm_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 
00002 <span class="comment">// Copyright Timothy Miller, 1999</span>
00003 
00004 <span class="preprocessor">#ifdef __GNUG__</span>
00005 <span class="preprocessor"></span><span class="preprocessor">    #pragma implementation "gterm.hpp"</span>
00006 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00007 <span class="preprocessor"></span>
00008 <span class="preprocessor">#include "<a class="code" href="gterm_8hpp.html">gterm.hpp</a>"</span>
00009 <span class="preprocessor">#include "../common/debug.h"</span>
00010 
00011 <span class="preprocessor">#ifdef _DEBUG</span>
00012 <span class="preprocessor"></span>
00013 <span class="preprocessor">#define new DEBUG_NEW</span>
00014 <span class="preprocessor"></span>
00015 <span class="preprocessor">#endif</span>
00016 <span class="preprocessor"></span>
<a name="l00017"></a><a class="code" href="class_g_term.html#a8">00017</a> <span class="keywordtype">void</span> <a class="code" href="class_g_term.html#a8">GTerm::Update</a>()
00018 {
00019     <a class="code" href="class_g_term.html#d7">update_changes</a>();
00020 }
00021 
<a name="l00033"></a><a class="code" href="class_g_term.html#a2">00033</a> <span class="keywordtype">void</span> <a class="code" href="class_g_term.html#a2">GTerm::ProcessInput</a>(<span class="keywordtype">int</span> len, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data)
00034 {
00035 <span class="comment">//printf("ProcessInput called...\n");</span>
00036     <span class="keywordtype">int</span> i;
00037     <a class="code" href="struct_state_option.html">StateOption</a> *last_state;
00038 
00039     <a class="code" href="class_g_term.html#r39">data_len</a> = len;
00040     <a class="code" href="class_g_term.html#r38">input_data</a> = data;
00041 
00042     <span class="keywordflow">while</span> (<a class="code" href="class_g_term.html#r39">data_len</a>) {
00043 <span class="comment">//printf("ProcessInput() processing %d...\n", *input_data);        </span>
00044         i = 0;
00045         <span class="keywordflow">while</span> (<a class="code" href="class_g_term.html#r22">current_state</a>[i].<a class="code" href="struct_state_option.html#o0">byte</a> != -1 &amp;&amp; 
00046                <a class="code" href="class_g_term.html#r22">current_state</a>[i].<a class="code" href="struct_state_option.html#o0">byte</a> != *<a class="code" href="class_g_term.html#r38">input_data</a>) i++;
00047 
00048         <span class="comment">// action must be allowed to redirect state change</span>
00049         last_state = <a class="code" href="class_g_term.html#r22">current_state</a>+i;
00050         <a class="code" href="class_g_term.html#r22">current_state</a> = last_state-&gt;<a class="code" href="struct_state_option.html#o2">next_state</a>;
00051         <span class="keywordflow">if</span> (last_state-&gt;<a class="code" href="struct_state_option.html#o1">action</a>) 
00052             (this-&gt;*(last_state-&gt;<a class="code" href="struct_state_option.html#o1">action</a>))();
00053         <a class="code" href="class_g_term.html#r38">input_data</a>++;
00054         <a class="code" href="class_g_term.html#r39">data_len</a>--;
00055     }
00056 
00057     <span class="keywordflow">if</span> (!(<a class="code" href="class_g_term.html#r20">mode_flags</a> &amp; <a class="code" href="class_g_term.html#w79w10">DEFERUPDATE</a>) ||
00058         (<a class="code" href="class_g_term.html#r10">pending_scroll</a> &gt; <a class="code" href="class_g_term.html#r3">scroll_bot</a>-<a class="code" href="class_g_term.html#r2">scroll_top</a>)) <a class="code" href="class_g_term.html#d7">update_changes</a>();
00059 }
00060 
<a name="l00061"></a><a class="code" href="class_g_term.html#a10">00061</a> <span class="keywordtype">void</span> <a class="code" href="class_g_term.html#a10">GTerm::Reset</a>()
00062 {
00063     <a class="code" href="class_g_term.html#d34">reset</a>();
00064 }
00065 
<a name="l00079"></a><a class="code" href="class_g_term.html#a9">00079</a> <span class="keywordtype">void</span> <a class="code" href="class_g_term.html#a9">GTerm::ExposeArea</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h)
00080 {
00081     <span class="keywordtype">int</span> i;
00082     <span class="keywordflow">for</span> (i=0; i&lt;h; i++) <a class="code" href="class_g_term.html#d11">changed_line</a>(i+y, x, x+w-1);
00083     <span class="keywordflow">if</span> (!(<a class="code" href="class_g_term.html#r20">mode_flags</a> &amp; <a class="code" href="class_g_term.html#w79w10">DEFERUPDATE</a>)) <a class="code" href="class_g_term.html#d7">update_changes</a>();
00084 }
00085 
<a name="l00098"></a><a class="code" href="class_g_term.html#a4">00098</a> <span class="keywordtype">void</span> <a class="code" href="class_g_term.html#a4">GTerm::ResizeTerminal</a>(<span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h)
00099 {
00100     <span class="keywordtype">int</span> cx, cy;
00101     <span class="comment">//clear_area(min(width,w), 0, MAXWIDTH-1, MAXHEIGHT-1);</span>
00102     <span class="comment">//clear_area(0, min(height,h), min(width,w)-1, MAXHEIGHT-1);</span>
00103 
00104 
00105     <span class="comment">//clear_area(0, )</span>
00106     <a class="code" href="class_g_term.html#r0">width</a> = w;
00107     <a class="code" href="class_g_term.html#r1">height</a> = h;
00108     <a class="code" href="class_g_term.html#r3">scroll_bot</a> = <a class="code" href="class_g_term.html#r1">height</a>-1;
00109     <span class="keywordflow">if</span> (<a class="code" href="class_g_term.html#r2">scroll_top</a> &gt;= <a class="code" href="class_g_term.html#r1">height</a>) <a class="code" href="class_g_term.html#r2">scroll_top</a> = 0;
00110     cx = <a class="code" href="gterm_8hpp.html#a2">min</a>(<a class="code" href="class_g_term.html#r0">width</a>-1, <a class="code" href="class_g_term.html#r13">cursor_x</a>);
00111     cy = <a class="code" href="gterm_8hpp.html#a2">min</a>(<a class="code" href="class_g_term.html#r1">height</a>-1, <a class="code" href="class_g_term.html#r14">cursor_y</a>);
00112     <a class="code" href="class_g_term.html#r5">tm</a>.<a class="code" href="class_text_manager.html#a27">Resize</a>(w, h);
00113     <a class="code" href="class_g_term.html#d12">move_cursor</a>(cx, cy);
00114 
00115     <span class="comment">//ExposeArea(0, 0, width - 1, height - 1);</span>
00116     <span class="comment">//Update();</span>
00117 }
00118 
<a name="l00119"></a><a class="code" href="class_g_term.html#a0">00119</a> <a class="code" href="class_g_term.html#a0">GTerm::GTerm</a>(<span class="keywordtype">int</span> w, <span class="keywordtype">int</span> h) : width(w), height(h)
00120 {
00121     <span class="keywordtype">int</span> i;
00122     <a class="code" href="class_g_term.html#r12">m_nextLineCounter</a> = 0;
00123 
00124     <a class="code" href="class_g_term.html#r11">doing_update</a> = 0;
00125 <span class="comment">/*</span>
00126 <span class="comment">    string blankline;</span>
00127 <span class="comment">    blankline.resize(MAXWIDTH, ' ');</span>
00128 <span class="comment">    textq = deque&lt;string&gt;(MAXHEIGHT, blankline);</span>
00129 <span class="comment">                   </span>
00130 <span class="comment">    alttext = new unsigned char[MAXWIDTH * MAXHEIGHT];</span>
00131 <span class="comment"></span>
00132 <span class="comment">    stringtext.clear();</span>
00133 <span class="comment"></span>
00134 <span class="comment">    stringtext.resize(MAXWIDTH * MAXHEIGHT, ' ');</span>
00135 <span class="comment">*/</span>
00136     <a class="code" href="class_text_manager.html">TextManager</a> temptm(<span class="keyword">this</span>, w, h, <a class="code" href="gterm_8hpp.html#a0">MAXWIDTH</a>, <a class="code" href="gterm_8hpp.html#a1">MAXHEIGHT</a>);
00137 
00138     <a class="code" href="class_g_term.html#r5">tm</a> = temptm;
00139 
00140 
00141     <span class="comment">// could make this dynamic</span>
00142     <a class="code" href="class_g_term.html#r4">text</a> = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>[<a class="code" href="gterm_8hpp.html#a0">MAXWIDTH</a>*<a class="code" href="gterm_8hpp.html#a1">MAXHEIGHT</a>];
00143     <a class="code" href="class_g_term.html#r6">color</a> = <span class="keyword">new</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>[<a class="code" href="gterm_8hpp.html#a0">MAXWIDTH</a>*<a class="code" href="gterm_8hpp.html#a1">MAXHEIGHT</a>];
00144 
00145     <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="gterm_8hpp.html#a1">MAXHEIGHT</a>; i++) {
00146         <span class="comment">// make it draw whole terminal to start</span>
00147         <a class="code" href="class_g_term.html#r8">dirty_startx</a>[i] = 0;
00148         <a class="code" href="class_g_term.html#r9">dirty_endx</a>[i] = <a class="code" href="gterm_8hpp.html#a0">MAXWIDTH</a>-1;
00149     }
00150 
00151 <span class="preprocessor">#ifdef GTERM_PC</span>
00152 <span class="preprocessor"></span>        <a class="code" href="class_g_term.html#r34">pc_machinename</a> = <span class="keyword">new</span> <span class="keywordtype">char</span>[7];
00153         strcpy(<a class="code" href="class_g_term.html#r34">pc_machinename</a>, <span class="stringliteral">"pcterm"</span>);
00154 <span class="preprocessor">#endif</span>
00155 <span class="preprocessor"></span>    <a class="code" href="class_g_term.html#r13">cursor_x</a> = 0;
00156     <a class="code" href="class_g_term.html#r14">cursor_y</a> = 0;
00157     <a class="code" href="class_g_term.html#r15">save_x</a> = 0;
00158     <a class="code" href="class_g_term.html#r16">save_y</a> = 0;
00159         <a class="code" href="class_g_term.html#r20">mode_flags</a> = 0;
00160     <a class="code" href="class_g_term.html#d34">reset</a>();
00161 }
00162 
<a name="l00163"></a><a class="code" href="class_g_term.html#a1">00163</a> <a class="code" href="class_g_term.html#a1">GTerm::~GTerm</a>()
00164 {
00165     <span class="comment">//delete[] alttext;</span>
00166     <span class="keyword">delete</span>[] <a class="code" href="class_g_term.html#r4">text</a>;
00167     <span class="keyword">delete</span>[] <a class="code" href="class_g_term.html#r6">color</a>;
00168 <span class="preprocessor">#ifdef GTERM_PC</span>
00169 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(<a class="code" href="class_g_term.html#r34">pc_machinename</a>)
00170           <span class="keyword">delete</span>[] <a class="code" href="class_g_term.html#r34">pc_machinename</a>;
00171 <span class="preprocessor">#endif // GTERM_PC</span>
00172 <span class="preprocessor"></span>}
00173 
00174 <span class="preprocessor">#ifdef GTERM_PC</span>
00175 <span class="preprocessor"></span><span class="keywordtype">void</span>
<a name="l00176"></a><a class="code" href="class_g_term.html#a35">00176</a> <a class="code" href="class_g_term.html#a35">GTerm::SetMachineName</a>(<span class="keywordtype">char</span> *machinename)
00177 {
00178   <span class="keywordflow">if</span>(<a class="code" href="class_g_term.html#r34">pc_machinename</a>)
00179     <span class="keyword">delete</span> <a class="code" href="class_g_term.html#r34">pc_machinename</a>;
00180 
00181   <a class="code" href="class_g_term.html#r34">pc_machinename</a> = <span class="keyword">new</span> <span class="keywordtype">char</span>[strlen(machinename) + 1];
00182   strcpy(<a class="code" href="class_g_term.html#r34">pc_machinename</a>, machinename);
00183 }
00184 <span class="preprocessor">#endif // GTERM_PC</span>
00185 <span class="preprocessor"></span>
00197 <span class="keywordtype">int</span>
<a name="l00198"></a><a class="code" href="class_g_term.html#a37">00198</a> <a class="code" href="class_g_term.html#a37">GTerm::IsSelected</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
00199 {
00200   <span class="keywordflow">if</span>(<a class="code" href="class_g_term.html#r6">color</a> &amp;&amp; x &gt;= 0 &amp;&amp; x &lt; Width() &amp;&amp; y &gt;= 0 &amp;&amp; y &lt; <a class="code" href="class_g_term.html#a6">Height</a>())
00201     <span class="comment">//return color[(linenumbers[y] * MAXWIDTH) + x] &amp; SELECTED;</span>
00202     <span class="keywordflow">return</span> (<a class="code" href="class_g_term.html#r5">tm</a>.<a class="code" href="class_text_manager.html#a10">GetColorAdjusted</a>(y, x) &amp; <a class="code" href="class_g_term.html#w79w16">SELECTED</a>);
00203   <span class="keywordflow">return</span> 0;
00204 }
00205 
00218 <span class="keywordtype">void</span>
<a name="l00219"></a><a class="code" href="class_g_term.html#a38">00219</a> <a class="code" href="class_g_term.html#a38">GTerm::Select</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y, <span class="keywordtype">int</span> select)
00220 {
00221     <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> firstColor = <a class="code" href="class_g_term.html#r5">tm</a>.<a class="code" href="class_text_manager.html#a10">GetColorAdjusted</a>(0, 0);
00222   <span class="keywordflow">if</span>(<a class="code" href="class_g_term.html#r6">color</a> &amp;&amp; x &gt;= 0 &amp;&amp; x &lt; Width() &amp;&amp; y &gt;= 0 &amp;&amp; y &lt; <a class="code" href="class_g_term.html#a6">Height</a>())
00223   <span class="comment">//if( (firstColor != 0) &amp;&amp; x &gt;= 0 &amp;&amp; x &lt; Width() &amp;&amp; y &gt;= 0 &amp;&amp; y &lt; Height())</span>
00224   {
00225       <span class="keywordtype">int</span> idx1 = <a class="code" href="class_g_term.html#r7">linenumbers</a>[y];
00226       <span class="keywordtype">int</span> idx2 = idx1 * <a class="code" href="gterm_8hpp.html#a0">MAXWIDTH</a>;
00227       <span class="keywordtype">int</span> idx3 = idx2 + x;
00228     <span class="keywordflow">if</span>(select)
00229     {
00230       <span class="comment">//color[(linenumbers[y] * MAXWIDTH) + x] |= SELECTED;</span>
00231       <a class="code" href="class_g_term.html#r6">color</a>[idx3] |= <a class="code" href="class_g_term.html#w79w16">SELECTED</a>;
00232       <span class="keywordtype">int</span> tempcolor = <a class="code" href="class_g_term.html#r5">tm</a>.<a class="code" href="class_text_manager.html#a10">GetColorAdjusted</a>(y, x);
00233       tempcolor |= <a class="code" href="class_g_term.html#w79w16">SELECTED</a>;
00234       <a class="code" href="class_g_term.html#r5">tm</a>.<a class="code" href="class_text_manager.html#a19">SetColorAdjusted</a>(y, x, tempcolor);
00235     }
00236     <span class="keywordflow">else</span>
00237     {
00238      <span class="comment">// color[(linenumbers[y] * MAXWIDTH) + x] &amp;= ~SELECTED;</span>
00239      <a class="code" href="class_g_term.html#r6">color</a>[idx3] &amp;= ~<a class="code" href="class_g_term.html#w79w16">SELECTED</a>;
00240      <span class="keywordtype">int</span> tempcolor = <a class="code" href="class_g_term.html#r5">tm</a>.<a class="code" href="class_text_manager.html#a10">GetColorAdjusted</a>(y, x);
00241      tempcolor &amp;= ~<a class="code" href="class_g_term.html#w79w16">SELECTED</a>;
00242      <a class="code" href="class_g_term.html#r5">tm</a>.<a class="code" href="class_text_manager.html#a19">SetColorAdjusted</a>(y, x, tempcolor);
00243     }
00244     <a class="code" href="class_g_term.html#d11">changed_line</a>(y, x, x);
00245 <span class="comment">//    update_changes();</span>
00246   }
00247 }
00248 
00249 <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>
<a name="l00250"></a><a class="code" href="class_g_term.html#a39">00250</a> <a class="code" href="class_g_term.html#a39">GTerm::GetChar</a>(<span class="keywordtype">int</span> x, <span class="keywordtype">int</span> y)
00251 {
00252   <span class="keywordflow">if</span>(<a class="code" href="class_g_term.html#r4">text</a> &amp;&amp; x &gt;= 0 &amp;&amp; x &lt; Width() &amp;&amp; y &gt;= 0 &amp;&amp; y &lt; <a class="code" href="class_g_term.html#a6">Height</a>())
00253     <span class="comment">//return text[(linenumbers[y] * MAXWIDTH) + x];</span>
00254     <span class="keywordflow">return</span> <a class="code" href="class_g_term.html#r5">tm</a>.<a class="code" href="class_text_manager.html#a8">GetCharAdjusted</a>(y, x);
00255 
00256   <span class="keywordflow">return</span> 0;
00257 }
00258 
<a name="l00259"></a><a class="code" href="class_g_term.html#a14">00259</a> <a class="code" href="class_text_manager.html">TextManager</a> <a class="code" href="class_g_term.html#a14">GTerm::GetTM</a>()
00260 {
00261     <span class="keywordflow">return</span> <a class="code" href="class_g_term.html#r5">tm</a>;
00262 }
00263 
<a name="l00264"></a><a class="code" href="class_g_term.html#a15">00264</a> <span class="keywordtype">int</span> <a class="code" href="class_g_term.html#a15">GTerm::GetColor</a>()
00265 {
00266     <span class="keywordflow">return</span> <a class="code" href="class_g_term.html#d13">calc_color</a>(<a class="code" href="class_g_term.html#r18">fg_color</a>, <a class="code" href="class_g_term.html#r19">bg_color</a>, <a class="code" href="class_g_term.html#r20">mode_flags</a>);
00267 }
00268 
<a name="l00269"></a><a class="code" href="class_g_term.html#a16">00269</a> <span class="keywordtype">void</span> <a class="code" href="class_g_term.html#a16">GTerm::DecodeColor</a>(<span class="keywordtype">int</span> color, <span class="keywordtype">int</span> &amp;fg_color, <span class="keywordtype">int</span> &amp;bg_color)
00270 {
00271     fg_color = (color &gt;&gt; 4) &amp; 0xf;
00272     bg_color = (color &gt;&gt; 8) &amp; 0xf;
00273 }
00274 
<a name="l00286"></a><a class="code" href="class_g_term.html#a11">00286</a> <span class="keywordtype">void</span> <a class="code" href="class_g_term.html#a11">GTerm::Scroll</a>(<span class="keywordtype">int</span> numLines, <span class="keywordtype">bool</span> scrollUp)
00287 {
00288     <a class="code" href="class_g_term.html#r5">tm</a>.<a class="code" href="class_text_manager.html#a26">Scroll</a>(numLines, scrollUp);
00289     <a class="code" href="class_g_term.html#a9">ExposeArea</a>(0, 0, <a class="code" href="class_g_term.html#r0">width</a>, <a class="code" href="class_g_term.html#r1">height</a>);
00290     <a class="code" href="class_g_term.html#d7">update_changes</a>();
00291 }
00292 
<a name="l00293"></a><a class="code" href="class_g_term.html#a18">00293</a> <span class="keywordtype">bool</span> <a class="code" href="class_g_term.html#a18">GTerm::IsScrolledUp</a>()
00294 {
00295     <span class="keywordflow">return</span> (<a class="code" href="class_g_term.html#r5">tm</a>.<a class="code" href="class_text_manager.html#a4">GetNumLinesScrolled</a>() != 0);
00296 }
00297 
<a name="l00306"></a><a class="code" href="class_g_term.html#a12">00306</a> <span class="keywordtype">int</span> <a class="code" href="class_g_term.html#a12">GTerm::GetScrollHeight</a>()
00307 {
00308     <span class="keywordtype">int</span> scrollHeight = <a class="code" href="class_g_term.html#r5">tm</a>.<a class="code" href="class_text_manager.html#a5">GetLinesReceived</a>();
00309 
00310     <span class="keywordtype">int</span> maxSize = <a class="code" href="class_g_term.html#r5">tm</a>.<a class="code" href="class_text_manager.html#a2">GetMaxSize</a>();
00311     <span class="keywordflow">if</span>(scrollHeight &gt; maxSize)
00312     {
00313         scrollHeight = maxSize;
00314     }
00315     <span class="keywordflow">else</span>
00316     {
00317         scrollHeight--;
00318     }
00319     
00320     <span class="keywordflow">return</span> scrollHeight;
00321 }
00322 
<a name="l00323"></a><a class="code" href="class_g_term.html#a13">00323</a> <span class="keywordtype">int</span> <a class="code" href="class_g_term.html#a13">GTerm::GetScrollPosition</a>()
00324 {
00325     <span class="keywordflow">return</span> <a class="code" href="class_g_term.html#r5">tm</a>.<a class="code" href="class_text_manager.html#a4">GetNumLinesScrolled</a>();
00326 }
00327 
<a name="l00328"></a><a class="code" href="class_g_term.html#a17">00328</a> <span class="keywordtype">void</span> <a class="code" href="class_g_term.html#a17">GTerm::SetTerminalHistory</a>(<span class="keywordtype">int</span> size)
00329 {
00330     <a class="code" href="class_g_term.html#r5">tm</a>.<a class="code" href="class_text_manager.html#a13">SetMaxSize</a>(size);
00331 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Apr 28 16:45:38 2004 for Chameleon by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.6 </small></address>
</body>
</html>
